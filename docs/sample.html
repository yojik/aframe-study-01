<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Hello, World! - A-Frame 〇×</title>
  <meta name="description" content="Hello, World! - A-Frame">
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.1.2/dist/socket.io.min.js"></script>
  <script src="https//unpkg.com/alpinejs" defer></script>
  <script>
    var socket = io.connect();
    var player_id;
    var player_no;

    //ログイン処理
    (function login() {
      document.querySelectorAll("a-camera").forEach(p => {
        playersCamera.setAttribute("camera", "active", false);
        playersCamera.setAttribute("look-controls", "enabled", false);
      })
      socket.emit("connected");
      console.log("ログイン")
    })();
    //サーバ接続後
    socket.on("set_player", function (p) {
      player_id = p.id;
      player_no = p.no
      var playersCamera = document.querySelector("#" + "player" + player_no);
      playersCamera.setAttribute("camera", "active", true);
      playersCamera.setAttribute("look-controls", "enabled", true);
      //二番目のユーザが反対側を向いてしまう問題を無理やり解決
      if (player_no == 2) {
        var playersCameraRig = document.querySelector("#" + "rig" + player_no);
        playersCameraRig.setAttribute("rotation", { x: 0, y: 180, z: 0 })
      }
    });
    socket.on("player_moving", function (p) {
      if(p.player_id!=player_id) {
        other_player_moving(p);
      }
    });
    socket.on("change_square", function (p) {
      change_square(p);
    });

    function other_player_moving(data) {
      var targetCamera = document.querySelector("#" + "player" + data.player_no);
      targetCamera.object3D.rotation.x =  data.cameraRotation.x
      targetCamera.object3D.rotation.y =  data.cameraRotation.y
    }
    function click_square(square_id) {
      changeData = {
        square_id :square_id,
        player_no: player_no
      }
      change_square(changeData);
      socket.emit("click_square",changeData);
    }
    function change_square(data) {
      const image = data.player_no==1?"#circle":"#cross"
      document.querySelector("#" + data.square_id).setAttribute("src", image);
    }
    AFRAME.registerComponent('cursor-listener', {
      init: function () {
        this.el.addEventListener("click", function (evt) {
          click_square(this.id);
        });
      }
    });
    //カメラの動作をトラッキングし、ブロードキャストする
    AFRAME.registerComponent('camera-tracker', {
      schema: {
        player_no: { type: 'int', default: '1' },
      },
      tick: function () {
        if(this.data.player_no!=player_no) return;
        var camera =this.el;
        var cameraPosition = {
          x: camera.object3D.position.x,
          y: camera.object3D.position.y,
          z: camera.object3D.position.z,
        }
        var cameraRotation = {
          x: camera.object3D.rotation.x,
          y: camera.object3D.rotation.y
        }
        var player_camera = {
          player_id: player_id,
          player_no: this.data.player_no,
          cameraPosition:cameraPosition,
          cameraRotation:cameraRotation

        }
        socket.emit("camera_tracking",player_camera);
      }
    });
  </script>


</head>

<body>
  <a-scene>
    <!-- <a-box position="- 1 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
      <a-sphere position="0 1.25 -5" radius="1.25" color="#EF2D5E"></a-sphere>
      <a-cylinder position="1 0.75 -3" radius="1" height="0" color="#FFC65D"></a-cylinder>
      <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane> -->
    <!-- <a-sky color="#ECECEC"></a-sky> -->
    <a-assets>
      <img src="http://i.imgur.com/7YnjGfI.png" id="square" crossorigin="anonymous">
      <img src="http://i.imgur.com/vxesSQm.png" id="circle" crossorigin="anonymous">
      <img src="http://i.imgur.com/EdymqIg.png" id="cross" crossorigin="anonymous">
    </a-assets>
    <!-- https://vr-lab.voyagegroup.com/entry/2016/12/26/231043 -->
    <a-entity scale="0.2 0.2 0.2" id="square">

      <!-- 右手座標系 
             - 親指人差し指中指を直角にした状態で、
               親指がx軸 人差し指がy軸  (xとyは普通のグラフと考える)
               中指がz軸   
             - かつaframeでは、
                親指を右、人差し指を上、中指を手前にする。
                z軸が奥行(手前が正)になる。
        -->
      <a-plane cursor-listener id="square0" src="#square" position="-1 0 -1" rotation="-90 0 0" width="1" height="1"
        color="#EEEEEE"></a-plane>
      <a-plane cursor-listener id="square1" src="#square" position="-1 0 0" rotation="-90 0 0" width="1" height="1"
        color="#EEEEEE"></a-plane>
      <a-plane cursor-listener id="square2" src="#square" position="-1 0 1" rotation="-90 0 0" width="1" height="1"
        color="#EEEEEE"></a-plane>

      <a-plane cursor-listener id="square3" src="#square" position="0 0  -1" rotation="-90 0 0" width="1" height="1"
        color="#EEEEEE"></a-plane>
      <a-plane cursor-listener id="square4" src="#square" position="0 0  0" rotation="-90 0 0" width="1" height="1"
        color="#EEEEEE"></a-plane>
      <a-plane cursor-listener id="square5" src="#square" position="0 0  1" rotation="-90 0 0" width="1" height="1"
        color="#EEEEEE"></a-plane>

      <a-plane cursor-listener id="square6" src="#square" position="1 0  -1" rotation="-90 0 0" width="1" height="1"
        color="#EEEEEE"></a-plane>
      <a-plane cursor-listener id="square7" src="#square" position="1 0  0" rotation="-90 0 0" width="1" height="1"
        color="#EEEEEE"></a-plane>
      <a-plane cursor-listener id="square8" src="#square" position="1 0  1" rotation="-90 0 0" width="1" height="1"
        color="#EEEEEE"></a-plane>
    </a-entity>

    <!-- mine camera-->
    <a-entity  id="rig1" scale="0.1 0.1 0.1" position="0 0.3 0.3" rotation="0 0 0">
      <a-camera camera-tracker="player_no:1" active="true" look-controls-enabled="true" id="player1">
        <a-cursor></a-cursor>
        <a-text position="0 1 0" color="blue" rotation="0 180 0" value="Player1"></a-text>
        <a-box color="blue"></a-box>
      </a-camera>
    </a-entity>

    <a-entity   id="rig2" scale="0.1 0.1 0.1" position="0 0.3 -0.3" rotation="0 180 0">
      <a-camera  camera-tracker="player_no:2" active="false" look-controls-enabled="false" id="player2">
        <a-cursor></a-cursor>
        <a-box color="red"></a-box>
        <a-text position="0 1 0" color="red" rotation="0 180 0" value="Player2"></a-text>
      </a-camera>
    </a-entity>

  </a-scene>
</body>

</html>